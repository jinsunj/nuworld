<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NU WORLD 236777 PROTOCOL</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  color: #cfcfcf;
  font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 300;
  height: 100%;
}

.screen {
  display: none;
  height: 100%;
  width: 100%;
  justify-content: center;
  align-items: center;
  text-align: center;
  flex-direction: column;
}

.active {
  display: flex;
}

h1 {
  font-size: 64px;
  margin-bottom: 140px;
  letter-spacing: 3px;
  font-weight: 200;
}

.title {
  letter-spacing: 6px;
}

.enter-label {
  font-size: 48px;
  letter-spacing: 2px;
  margin-bottom: 20px;
}

button {
  background: transparent;
  border: 1px solid #777;
  color: #cfcfcf;
  padding: 18px 36px;
  font-family: inherit;
  cursor: pointer;
  font-size: 20px;
  margin-top: 40px;
}

#exploreBtn {
  animation: pulse 1.6s infinite;
  border-color: #cfcfcf;
}

@keyframes pulse {
  0% { opacity: 0.4; }
  50% { opacity: 1; }
  100% { opacity: 0.4; }
}

input {
  background: transparent;
  border: 1px solid #555;
  color: #cfcfcf;
  padding: 18px;
  font-family: inherit;
  margin-bottom: 20px;
  font-size: 20px;
}

.small {
  font-size: 18px;
  opacity: 0.6;
}

.big {
  font-size: 36px;
  margin-top: 10px;
}

#converting {
  font-size: 20px;
  letter-spacing: 2px;
}

/* TRACE ARCHIVE */
#traceArchive {
  position: fixed;
  inset: 0;
  background: black;
  pointer-events: none;
  display: none;
}

.trace-item {
  position: absolute;
  transform: translate(-50%, -50%);
  opacity: 0.9;
  white-space: nowrap;
  font-size: 24px; /* ✅ 요청한 크기 */
}

/* RESULT SCALE */
#result {
  transform: scale(0.7);
  transform-origin: center;
}

/* ENDING */
#infinity {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 420px;
  color: white;
  display: none;
}

#preInfinity {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 28px;
  letter-spacing: 3px;
  opacity: 0.85;
  display: none;
  text-align: center;
}

@media (max-width: 768px) {
  h1 { font-size: 64px; }
  #result h1 { font-size: 72px; }
  .big { font-size: 40px; }
  .small { font-size: 20px; }
  #converting { font-size: 32px; }
  input { font-size: 28px; }
  button { font-size: 28px; }
  #infinity { font-size: 70vw; }
  #preInfinity { font-size: 36px; }
  .enter-label { font-size: 36px; }
}
</style>
</head>

<body>

<!-- SCREEN 1 -->
<div class="screen active" id="home">
  <h1 class="title">NU WORLD 236777 PROTOCOL</h1>
  <button onclick="goToInput()">LOGOUT</button>
</div>

<!-- SCREEN 2 -->
<div class="screen" id="input">
  <div class="enter-label">ENTER YOUR NAME</div>
  <input id="nameInput" placeholder="name">
  <button onclick="startConvert()">LOGOUT</button>
</div>

<!-- SCREEN 3 -->
<div class="screen" id="convert">
  <div id="converting">CONVERTING TRACE</div>
</div>

<!-- SCREEN 4 -->
<div class="screen" id="result">
  <h1>WELCOME TO IDEA.</h1>
  <div class="big" id="userTrace"></div>
  <div class="small">THIS TRACE IS REVERSIBLE AND ENCODED IN UNICODE.</div>
  <br><br>
  <div class="big" id="totalTraces"></div>
  <div class="small">THIS ARCHIVE IS LOCAL</div>
  <br><br>
  <button id="exploreBtn" onclick="enterIdea()">EXPLORE IDEA?</button>
</div>

<div id="traceArchive"></div>
<div id="preInfinity"></div>
<div id="infinity">∞</div>

<script>
/* SUPABASE */
const SUPABASE_URL = "https://lnbrorrwoxqqpijylyhv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_s10vM9wJnHdVgHEzSL4mfA_JvWMBiNn";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let traceNumber = "";

/* NAV */
function goToInput() { switchScreen("input"); }

function startConvert() {
  const name = document.getElementById("nameInput").value;
  if (!name) return;

  traceNumber = encodeName(name);
  switchScreen("convert");

  let dots = 0;
  const el = document.getElementById("converting");

  const interval = setInterval(() => {
    dots = (dots + 1) % 4;
    el.innerText = "CONVERTING TRACE" + ".".repeat(dots);
  }, 500);

  setTimeout(() => {
    clearInterval(interval);
    showResult();
  }, 3000);
}

function encodeName(name) {
  return Array.from(name).map(c => c.charCodeAt(0)).join("-");
}

async function showResult() {
  switchScreen("result");

  document.getElementById("userTrace").innerText =
    "USER TRACE : " + traceNumber;

  await supabaseClient.from("traces").insert([{ trace_id: traceNumber }]);

  const { count } = await supabaseClient
    .from("traces")
    .select("*", { count: "exact", head: true });

  document.getElementById("totalTraces").innerText =
    "TOTAL TRACES STORED : " + count;
}

/* ARCHIVE FLOOD */
async function showTraceArchive() {
  switchScreen(null);

  const archive = document.getElementById("traceArchive");
  const infinity = document.getElementById("infinity");
  const preInfinity = document.getElementById("preInfinity");

  archive.innerHTML = "";
  archive.style.display = "block";

  const { data } = await supabaseClient
    .from("traces")
    .select("trace_id")
    .order("created_at", { ascending: true });

  let i = 0;
  const interval = setInterval(() => {
    if (i >= data.length) {
      clearInterval(interval);
      setTimeout(() => {
        archive.style.display = "none";
        preInfinity.innerText =
          `YOU ARE THE ${data.length}th TRACE BEFORE ARCHIVAL`;
        preInfinity.style.display = "block";

        setTimeout(() => {
          preInfinity.style.display = "none";
          infinity.style.display = "block";
        }, 3000);
      }, 2000);
      return;
    }

    const item = document.createElement("div");
    item.className = "trace-item";
    item.innerText = data[i].trace_id;

    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight * 0.72; 

    const offsetX = (Math.random() - 0.5) * window.innerWidth * 0.5;
    const offsetY = (Math.random() - 0.5) * window.innerHeight * 0.25;

    item.style.left = centerX + offsetX + "px";
    item.style.top = centerY + offsetY + "px";

    archive.appendChild(item);
    i++;
  }, 100);
}

function enterIdea() { showTraceArchive(); }

function switchScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  if (id) document.getElementById(id).classList.add("active");
}
</script>

</body>
</html>
