<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NU_WORLD_236777_protocol</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  color: #cfcfcf;
  font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 300;
  height: 100%;
}

.screen {
  display: none;
  height: 100%;
  width: 100%;
  justify-content: center;
  align-items: center;
  text-align: center;
  flex-direction: column;
}

.active {
  display: flex;
}

h1 {
  font-size: 64px;
  margin-bottom: 30px;
  letter-spacing: 3px;
  font-weight: 200;
}

button {
  background: transparent;
  border: 1px solid #777;
  color: #cfcfcf;
  padding: 10px 20px;
  font-family: inherit;
  cursor: pointer;
}

#exploreBtn {
  animation: pulse 1.6s infinite;
  border-color: #cfcfcf;
}

@keyframes pulse {
  0% {
    opacity: 0.4;
  }
  50% {
    opacity: 1;
  }
  100% {
    opacity: 0.4;
  }
}

input {
  background: transparent;
  border: 1px solid #555;
  color: #cfcfcf;
  padding: 10px;
  font-family: inherit;
  margin-bottom: 20px;
}

.small {
  font-size: 12px;
  opacity: 0.6;
}

.big {
  font-size: 24px;
  margin-top: 10px;
}

#converting {
  font-size: 20px;
  letter-spacing: 2px;
}

#numberFlood {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: black;
  color: #cfcfcf;
  font-size: 14px;
  overflow: hidden;
  display: none;
}

#traceArchive {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: black;
  color: #cfcfcf;
  font-size: 18px;
  line-height: 1.6;
  letter-spacing: 1px;
  padding: 40px;
  overflow-y: auto;
  display: none;
  font-family: "Pretendard", monospace;
}

#infinity {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 420px;
  color: white;
  display: none;
}
</style>
</head>

<body>

<!-- SCREEN 1 -->
<div class="screen active" id="home">
  <h1>NU_WORLD_236777_PROTOCOL</h1>
  <button onclick="goToInput()">LOGOUT</button>
</div>

<!-- SCREEN 2 -->
<div class="screen" id="input">
  <div>ENTER YOUR NAME</div><br>
  <input id="nameInput" placeholder="name">
  <button onclick="startConvert()">LOGOUT</button>
</div>

<!-- SCREEN 3 -->
<div class="screen" id="convert">
  <div id="converting">CONVERTING TRACE</div>
</div>

<!-- SCREEN 4 -->
<div class="screen" id="result">
  <h1>WELCOME TO IDEA.</h1>

  <div class="big" id="userTrace"></div>
  <div class="small">THIS NUMBER IS ENCODED IN UNICODE.</div>

  <br><br>

  <div class="big" id="totalTraces"></div>
  <div class="small">THIS ARCHIVE IS LOCAL</div>

  <br><br>

  <button id="exploreBtn" onclick="enterIdea()">EXPLORE IDEA?</button>
</div>

<div id="traceArchive"></div>
<div id="numberFlood"></div>
<div id="infinity">∞</div>

<script>
/* =========================
   SUPABASE CONFIG (STEP 1)
========================= */
const SUPABASE_URL = "https://lnbrorrwoxqqpijylyhv.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_s10vM9wJnHdVgHEzSL4mfA_JvWMBiNn";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =========================
   CORE LOGIC
========================= */
let traceNumber = 0;

function goToInput() {
  switchScreen("input");
}

function startConvert() {
  const name = document.getElementById("nameInput").value;
  if (!name) return;

  traceNumber = encodeName(name);
  switchScreen("convert");

  let dots = 0;
  const el = document.getElementById("converting");

  const interval = setInterval(() => {
    dots = (dots + 1) % 4;
    el.innerText = "CONVERTING TRACE" + ".".repeat(dots);
  }, 500);

  setTimeout(() => {
    clearInterval(interval);
    showResult();
  }, 3000);
}

function encodeName(name) {
  let sum = 0;
  for (let i = 0; i < name.length; i++) {
    sum += name.charCodeAt(i);
  }
  return sum;
}

function showResult() {
  switchScreen("result");

  document.getElementById("userTrace").innerText =
    "USER TRACE : " + traceNumber;

  let total = Number(localStorage.getItem("totalTraces") || 0) + 1;
  localStorage.setItem("totalTraces", total);

  document.getElementById("totalTraces").innerText =
    "TOTAL TRACES STORED : " + total;

  // SAVE TRACE TO SUPABASE
  supabaseClient
    .from("traces")
    .insert([{ trace_id: traceNumber }]);
}

async function showTraceArchive() {
  switchScreen(null);

  const archive = document.getElementById("traceArchive");
  archive.innerHTML = "";
  archive.style.display = "block";

  const { data, error } = await supabaseClient
    .from("traces")
    .select("trace_id")
    .order("created_at", { ascending: true });

  if (error) {
    archive.innerText = "ARCHIVE CORRUPTED";
    return;
  }

  data.forEach((row, i) => {
    const line = document.createElement("div");
    line.innerText = row.trace_id;
    archive.appendChild(line);
  });

  // 3초 후 무한대로 이동
  setTimeout(() => {
    archive.style.display = "none";
    document.getElementById("infinity").style.display = "block";
  }, 3000);
}

function enterIdea() {
  showTraceArchive();
}

function switchScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  if (id) {
    document.getElementById(id).classList.add("active");
  }
}
</script>

</body>
</html>